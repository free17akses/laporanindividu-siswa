<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan Psikologis - Profesional</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #1e293b;
            --accent: #2563eb;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #cbd5e1;
            
            /* Toast Colors */
            --success: #10b981;
            --error: #ef4444;
            --info: #3b82f6;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; background-color: var(--bg-body); color: var(--text-main); transition: background 0.3s; }
        
        /* Locked Mode Styling */
        body.is-locked { background-color: #cbd5e1; }
        body.is-locked .config-panel { opacity: 0.5; pointer-events: none; filter: grayscale(0.8); }
        body.is-locked .sig-action-btns, 
        body.is-locked .sig-controls { display: none !important; }
        body.is-locked [contenteditable="true"] { pointer-events: none; outline: none; }
        body.is-locked .sig-canvas { cursor: default; }
        body.is-locked select, body.is-locked input, body.is-locked textarea { pointer-events: none; background: #f8fafc !important; border-color: transparent !important; }

        /* --- Toast Notification --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 250px; padding: 14px 20px; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }
        .toast.info { background: var(--info); }

        /* --- Navigation --- */
        .admin-nav { background: #ffffff; padding: 10px 20px; border-bottom: 2px solid var(--primary); position: sticky; top: 0; z-index: 1000; display: flex; justify-content: center; gap: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .btn { padding: 10px 18px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; border: 1px solid var(--border); transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; background: white; color: var(--text-main); }
        .btn:hover { transform: translateY(-1px); background: #f8fafc; }
        .btn-primary { background: var(--accent); color: white; border: none; }
        .btn-danger { color: #dc2626; border-color: #fecaca; }
        .btn-lock { background: #334155; color: white; border: none; min-width: 160px; justify-content: center; }
        .btn-lock.active { background: #ef4444; }

        /* --- Input Form Panel --- */
        .config-panel { max-width: 210mm; margin: 20px auto; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid var(--border); transition: all 0.3s; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .config-group { display: flex; flex-direction: column; gap: 8px; }
        .config-group label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .config-input, .config-select { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; outline: none; transition: border-color 0.2s; }
        .config-input:focus, .config-select:focus { border-color: var(--accent); }
        .config-title { font-size: 16px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--primary); }

        /* --- Document --- */
        .paper-wrapper { max-width: 210mm; margin: 0 auto 50px auto; }
        main { background: var(--bg-card); min-height: 297mm; box-shadow: 0 10px 30px rgba(0,0,0,0.05); display: flex; flex-direction: column; border-radius: 4px; overflow: hidden; position: relative; }

        header { background: var(--primary); color: white; padding: 40px 50px; display: flex; align-items: center; gap: 30px; position: relative; }
        .badge-secret { position: absolute; top: 0; right: 50px; background: #fde047; color: #b91c1c; padding: 10px 25px; font-weight: 900; font-size: 12px; border-radius: 0 0 8px 8px; }
        
        .logo-container { width: 80px; height: 80px; background: white; border-radius: 12px; padding: 5px; display: flex; align-items: center; justify-content: center; }
        .logo-box { max-width: 100%; max-height: 100%; }

        .content-body { padding: 40px 50px; flex: 1; }
        h2 { font-size: 14px; text-transform: uppercase; border-left: 5px solid var(--accent); padding-left: 15px; margin-bottom: 20px; }

        .student-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 30px; }
        .info-field label { display: block; font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 5px; }
        .info-field-val { font-weight: 700; font-size: 15px; border-bottom: 1px solid #cbd5e1; min-height: 25px; display: block; }

        /* --- Table --- */
        .assessment-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .assessment-table th { background: #f1f5f9; padding: 12px; font-size: 11px; text-transform: uppercase; border: 1px solid #e2e8f0; text-align: left; }
        .assessment-table td { padding: 10px; border: 1px solid #e2e8f0; vertical-align: middle; }
        .score-val { width: 60px; text-align: center; font-weight: 800; border: 1px solid #cbd5e1; border-radius: 4px; padding: 5px; }
        .progress-bar { width: 100%; height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        
        .row-comment-box { 
            width: 100%; 
            min-height: 40px; 
            border: 1px solid #e2e8f0; 
            border-radius: 4px; 
            padding: 5px 8px; 
            font-size: 12px; 
            font-family: inherit; 
            resize: vertical;
        }

        /* --- Textarea styling --- */
        .custom-textarea { 
            width: 100%; 
            min-height: 120px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 15px; 
            font-family: inherit; 
            font-size: 14px; 
            margin-bottom: 25px;
            resize: vertical;
        }

        /* --- Multi-Signature Layout --- */
        .signature-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-top: 40px; }
        .sig-box { text-align: center; border: 1px dashed transparent; padding: 10px; transition: border 0.3s; position: relative; }
        .sig-box:hover:not(.locked) { border-color: #e2e8f0; border-radius: 8px; }
        .sig-box.hidden { display: none !important; }
        
        .sig-controls { margin-bottom: 10px; display: flex; flex-direction: column; gap: 5px; }
        .sig-role-display { font-size: 12px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; display: block; }

        .sig-capture-area { position: relative; height: 110px; background: #fafafa; border-bottom: 2px solid var(--primary); margin-bottom: 15px; }
        .sig-canvas { width: 100%; height: 100%; cursor: crosshair; }
        .sig-upload-preview { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; background: white; pointer-events: none; display: none; }
        
        .sig-action-btns { position: absolute; bottom: 5px; right: 5px; display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; }
        .sig-capture-area:hover .sig-action-btns { opacity: 1; }
        .sig-mini-btn { font-size: 9px; padding: 2px 6px; cursor: pointer; background: white; border: 1px solid #cbd5e1; border-radius: 4px; }

        .sig-name-display { font-weight: 800; font-size: 14px; margin-top: 5px; display: block; }
        .sig-nip-display { font-size: 11px; color: var(--text-muted); display: block; }

        footer { background: #f8fafc; border-top: 4px solid var(--primary); padding: 20px 50px; display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; }

        @media print {
            .admin-nav, .config-panel, .no-print, #toast-container, .sig-action-btns { display: none !important; }
            .sig-box { border: none !important; }
            .paper-wrapper { margin: 0; max-width: 100%; }
            main { box-shadow: none; border-radius: 0; }
            textarea { border: none !important; padding: 0 !important; overflow: hidden; resize: none; background: transparent !important; }
            select, input { border: none !important; background: transparent !important; appearance: none; -webkit-appearance: none; }
            .assessment-table td { padding: 8px; }
            .row-comment-box { border: none !important; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<nav class="admin-nav no-print">
    <button class="btn btn-lock" id="btn-lock" onclick="toggleLock()">üîí KUNCI DOKUMEN</button>
    <div style="border-left: 1px solid var(--border); height: 30px; margin: 0 5px;"></div>
    
    <button class="btn" onclick="document.getElementById('logo-upload').click()">üñºÔ∏è Logo</button>
    <input type="file" id="logo-upload" hidden accept="image/*" onchange="loadLogo(this)">
    
    <button class="btn" onclick="document.getElementById('import-excel').click()">üìä Impor Data</button>
    <input type="file" id="import-excel" hidden accept=".xlsx, .xls" onchange="handleExcel(this)">
    
    <button class="btn" onclick="exportJSON()">üíæ Cadangkan</button>
    
    <div style="flex-grow: 1"></div>
    <button class="btn btn-danger" onclick="resetForm()">üóëÔ∏è Reset</button>
    <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è CETAK PDF</button>
</nav>

<!-- Configuration Panel (Top Form) -->
<div class="config-panel no-print">
    <div class="config-title">üìù Panel Pengaturan Data Laporan</div>
    <div class="config-grid">
        <div class="config-group">
            <label>Nama Subjek</label>
            <input type="text" id="cfg-nama" class="config-input save" placeholder="Nama Lengkap..." oninput="syncData()">
        </div>
        <div class="config-group">
            <label>NISN / Identitas</label>
            <input type="text" id="cfg-id" class="config-input save" placeholder="NISN / ID..." oninput="syncData()">
        </div>
        <div class="config-group">
            <label>Unit / Kelas</label>
            <select id="cfg-kelas" class="config-select save" onchange="syncData()">
                <option value="">-- Pilih Unit --</option>
                <option value="SD - Kelas 1">SD - Kelas 1</option>
                <option value="SD - Kelas 2">SD - Kelas 2</option>
                <option value="SD - Kelas 3">SD - Kelas 3</option>
                <option value="SD - Kelas 4">SD - Kelas 4</option>
                <option value="SD - Kelas 5">SD - Kelas 5</option>
                <option value="SD - Kelas 6">SD - Kelas 6</option>
                <option value="SMP - Kelas 7">SMP - Kelas 7</option>
                <option value="SMP - Kelas 8">SMP - Kelas 8</option>
                <option value="SMP - Kelas 9">SMP - Kelas 9</option>
                <option value="SMA - Kelas 10">SMA - Kelas 10</option>
                <option value="SMA - Kelas 11">SMA - Kelas 11</option>
                <option value="SMA - Kelas 12">SMA - Kelas 12</option>
            </select>
        </div>
        <div class="config-group">
            <label>Tanggal Laporan</label>
            <input type="text" id="cfg-tgl" class="config-input save" value="28 Januari 2026" oninput="syncData()">
        </div>

        <div class="config-group">
            <label>Nama Wali Kelas</label>
            <input type="text" id="cfg-nm-1" class="config-input save" placeholder="Nama Guru..." oninput="syncData()">
            <input type="text" id="cfg-nip-1" class="config-input save" placeholder="NIP/NIY..." oninput="syncData()">
        </div>
        <div class="config-group">
            <label>Nama Orang Tua</label>
            <input type="text" id="cfg-nm-2" class="config-input save" placeholder="Nama Wali Murid..." oninput="syncData()">
        </div>
        <div class="config-group">
            <label>Guru Pendamping Khusus (GPK)</label>
            <input type="text" id="cfg-nm-3" class="config-input save" placeholder="Nama GPK..." oninput="syncData()">
            <input type="text" id="cfg-nip-3" class="config-input save" placeholder="NIP/NIY..." oninput="syncData()">
        </div>
        <div class="config-group">
            <label>Nama Kepala Sekolah</label>
            <input type="text" id="cfg-nm-4" class="config-input save" placeholder="Nama Kepala Sekolah..." oninput="syncData()">
            <input type="text" id="cfg-nip-4" class="config-input save" placeholder="NIP/NIY..." oninput="syncData()">
        </div>
    </div>
</div>

<div class="paper-wrapper">
    <main>
        <header>
            <div class="badge-secret">RAHASIA</div>
            <div class="logo-container">
                <img id="logo-img" src="https://via.placeholder.com/150?text=LOGO" class="logo-box">
            </div>
            <div class="header-titles">
                <h1 contenteditable="true">LAPORAN ASESMEN PSIKOLOGIS</h1>
                <p contenteditable="true">LEMBAGA PSIKOLOGI & PENDIDIKAN TERPADU</p>
            </div>
        </header>

        <div class="content-body">
            <div class="student-info">
                <div class="info-field">
                    <label>Nama Lengkap Subjek</label>
                    <span class="info-field-val" id="doc-nama"></span>
                </div>
                <div class="info-field">
                    <label>ID / NISN</label>
                    <span class="info-field-val" id="doc-id"></span>
                </div>
                <div class="info-field">
                    <label>Unit / Kelas</label>
                    <span class="info-field-val" id="doc-kelas"></span>
                </div>
                <div class="info-field">
                    <label>Tanggal Laporan</label>
                    <span class="info-field-val" id="doc-tgl"></span>
                </div>
            </div>

            <section>
                <h2>I. Profil Aspek Psikologis</h2>
                <table class="assessment-table">
                    <thead>
                        <tr>
                            <th>Dimensi Aspek</th>
                            <th width="120">Skor</th>
                            <th width="150">Kategori</th>
                            <th>Keterangan / Analisis Aspek</th>
                        </tr>
                    </thead>
                    <tbody id="aspek-rows"></tbody>
                </table>
            </section>

            <section>
                <h2>II. Analisis Dinamika Psikologis</h2>
                <textarea id="txt-analisis" class="save custom-textarea" placeholder="Tuliskan analisis dinamika psikologis subjek secara mendalam di sini..."></textarea>
            </section>

            <section>
                <h2>III. Rekomendasi & Saran</h2>
                <textarea id="txt-saran" class="save custom-textarea" placeholder="Tuliskan saran tindak lanjut bagi orang tua dan sekolah..."></textarea>
            </section>

            <div class="signature-grid">
                <!-- Wali Kelas -->
                <div class="sig-box" id="sig-box-1">
                    <div class="sig-controls no-print">
                        <select class="sig-role-select save" id="role-1" onchange="toggleSig(1)">
                            <option value="Wali Kelas">Wali Kelas</option>
                            <option value="Sembunyikan">Sembunyikan</option>
                        </select>
                    </div>
                    <span class="sig-role-display" id="role-label-1">Wali Kelas</span>
                    <div class="sig-capture-area">
                        <canvas id="can-1" class="sig-canvas"></canvas>
                        <img id="img-pre-1" class="sig-upload-preview">
                        <div class="sig-action-btns">
                            <button class="sig-mini-btn" onclick="clearSig(1)">Hapus</button>
                            <button class="sig-mini-btn" onclick="document.getElementById('up-1').click()">Upload</button>
                            <input type="file" id="up-1" hidden accept="image/*" onchange="uploadSig(this, 1)">
                        </div>
                    </div>
                    <span class="sig-name-display" id="doc-nm-1"></span>
                    <span class="sig-nip-display" id="doc-nip-1"></span>
                </div>

                <!-- Wali Murid -->
                <div class="sig-box" id="sig-box-2">
                    <div class="sig-controls no-print">
                        <select class="sig-role-select save" id="role-2" onchange="toggleSig(2)">
                            <option value="Orang Tua / Wali Murid">Wali Murid</option>
                            <option value="Sembunyikan">Sembunyikan</option>
                        </select>
                    </div>
                    <span class="sig-role-display" id="role-label-2">Wali Murid</span>
                    <div class="sig-capture-area">
                        <canvas id="can-2" class="sig-canvas"></canvas>
                        <img id="img-pre-2" class="sig-upload-preview">
                        <div class="sig-action-btns">
                            <button class="sig-mini-btn" onclick="clearSig(2)">Hapus</button>
                            <button class="sig-mini-btn" onclick="document.getElementById('up-2').click()">Upload</button>
                            <input type="file" id="up-2" hidden accept="image/*" onchange="uploadSig(this, 2)">
                        </div>
                    </div>
                    <span class="sig-name-display" id="doc-nm-2"></span>
                    <span class="sig-nip-display" id="doc-nip-2"></span>
                </div>

                <!-- GPK -->
                <div class="sig-box" id="sig-box-3">
                    <div class="sig-controls no-print">
                        <select class="sig-role-select save" id="role-3" onchange="toggleSig(3)">
                            <option value="Guru Pendamping Khusus">GPK</option>
                            <option value="Psikolog Pemeriksa">Psikolog</option>
                            <option value="Sembunyikan">Sembunyikan</option>
                        </select>
                    </div>
                    <span class="sig-role-display" id="role-label-3">Guru Pendamping Khusus</span>
                    <div class="sig-capture-area">
                        <canvas id="can-3" class="sig-canvas"></canvas>
                        <img id="img-pre-3" class="sig-upload-preview">
                        <div class="sig-action-btns">
                            <button class="sig-mini-btn" onclick="clearSig(3)">Hapus</button>
                            <button class="sig-mini-btn" onclick="document.getElementById('up-3').click()">Upload</button>
                            <input type="file" id="up-3" hidden accept="image/*" onchange="uploadSig(this, 3)">
                        </div>
                    </div>
                    <span class="sig-name-display" id="doc-nm-3"></span>
                    <span class="sig-nip-display" id="doc-nip-3"></span>
                </div>

                <!-- Kepala Sekolah -->
                <div class="sig-box" id="sig-box-4">
                    <div class="sig-controls no-print">
                        <select class="sig-role-select save" id="role-4" onchange="toggleSig(4)">
                            <option value="Kepala Sekolah">Kepala Sekolah</option>
                            <option value="Sembunyikan">Sembunyikan</option>
                        </select>
                    </div>
                    <span class="sig-role-display" id="role-label-4">Kepala Sekolah</span>
                    <div class="sig-capture-area">
                        <canvas id="can-4" class="sig-canvas"></canvas>
                        <img id="img-pre-4" class="sig-upload-preview">
                        <div class="sig-action-btns">
                            <button class="sig-mini-btn" onclick="clearSig(4)">Hapus</button>
                            <button class="sig-mini-btn" onclick="document.getElementById('up-4').click()">Upload</button>
                            <input type="file" id="up-4" hidden accept="image/*" onchange="uploadSig(this, 4)">
                        </div>
                    </div>
                    <span class="sig-name-display" id="doc-nm-4"></span>
                    <span class="sig-nip-display" id="doc-nip-4"></span>
                </div>
            </div>
        </div>

        <footer>
            <div>Subjek: <span id="f-nama">-</span></div>
            <div>Identitas: <span id="f-id">-</span></div>
            <div>Dokumen Resmi Institusi</div>
        </footer>
    </main>
</div>

<script>
    const ASPEK = [
        "Potensi Intelektual", "Kematangan Emosi", "Motivasi Belajar", 
        "Interaksi Sosial", "Kemampuan Adaptasi", "Konsentrasi"
    ];

    let isLocked = false;

    function showToast(msg, type = 'success') {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `${type==='error'?'‚ùå':'‚úîÔ∏è'} ${msg}`;
        c.appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; setTimeout(()=>t.remove(), 300); }, 3000);
    }

    function toggleLock() {
        isLocked = !isLocked;
        applyLockState();
        autoSave();
        showToast(isLocked ? "Dokumen Terkunci" : "Dokumen Dibuka", isLocked ? "info" : "success");
    }

    function applyLockState() {
        const btn = document.getElementById('btn-lock');
        if(isLocked) {
            document.body.classList.add('is-locked');
            btn.classList.add('active');
            btn.innerHTML = "üîì BUKA KUNCI";
        } else {
            document.body.classList.remove('is-locked');
            btn.classList.remove('active');
            btn.innerHTML = "üîí KUNCI DOKUMEN";
        }
        
        document.querySelectorAll('input, select, textarea').forEach(el => {
            if(el.id !== 'btn-lock') el.disabled = isLocked;
        });
    }

    function syncData() {
        document.getElementById('doc-nama').innerText = document.getElementById('cfg-nama').value;
        document.getElementById('doc-id').innerText = document.getElementById('cfg-id').value;
        document.getElementById('doc-kelas').innerText = document.getElementById('cfg-kelas').value;
        document.getElementById('doc-tgl').innerText = document.getElementById('cfg-tgl').value;
        
        for(let i=1; i<=4; i++) {
            const nmInput = document.getElementById('cfg-nm-' + i);
            const nipInput = document.getElementById('cfg-nip-' + i);
            if(nmInput) document.getElementById('doc-nm-' + i).innerText = nmInput.value || (i===2 ? '(Nama Wali Murid)' : '');
            if(nipInput) document.getElementById('doc-nip-' + i).innerText = nipInput.value ? 'NIP/NIY. ' + nipInput.value : '';
        }

        document.getElementById('f-nama').innerText = document.getElementById('cfg-nama').value || '-';
        document.getElementById('f-id').innerText = document.getElementById('cfg-id').value || '-';
        
        autoSave();
    }

    function init() {
        const container = document.getElementById('aspek-rows');
        ASPEK.forEach((a, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${a}</strong></td>
                <td>
                    <input type="number" id="sc-${i}" class="save score-val" value="75" oninput="updateBar(${i})">
                    <div class="progress-bar"><div id="bar-${i}" class="progress-fill"></div></div>
                </td>
                <td>
                    <select id="sel-${i}" class="save config-select" style="width:100%" onchange="autoSave()">
                        <option value="Sangat Tinggi">Sangat Tinggi</option>
                        <option value="Tinggi">Tinggi</option>
                        <option value="Rata-rata" selected>Rata-rata</option>
                        <option value="Kurang">Kurang</option>
                        <option value="Sangat Kurang">Sangat Kurang</option>
                    </select>
                </td>
                <td>
                    <textarea id="comm-${i}" class="save row-comment-box" placeholder="Analisis aspek..." oninput="autoSave()"></textarea>
                </td>
            `;
            container.appendChild(tr);
            updateBar(i);
        });
        [1,2,3,4].forEach(setupCanvas);
        loadData();
        syncData();
        applyLockState();
    }

    function updateBar(i) {
        const val = document.getElementById('sc-' + i).value;
        const bar = document.getElementById('bar-' + i);
        bar.style.width = Math.min(val, 100) + '%';
        bar.style.backgroundColor = val >= 80 ? '#10b981' : (val >= 60 ? '#2563eb' : '#f59e0b');
        autoSave();
    }

    function toggleSig(id) {
        const val = document.getElementById('role-' + id).value;
        const box = document.getElementById('sig-box-' + id);
        const label = document.getElementById('role-label-' + id);
        
        if(val === 'Sembunyikan') {
            box.classList.add('hidden');
        } else {
            box.classList.remove('hidden');
            label.innerText = val;
        }
        autoSave();
    }

    function setupCanvas(id) {
        const canvas = document.getElementById('can-' + id);
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        let drawing = false;
        ctx.strokeStyle = "#1e293b"; ctx.lineWidth = 2; ctx.lineCap = "round";

        const getPos = (e) => {
            const r = canvas.getBoundingClientRect();
            return { x: (e.clientX || e.touches[0].clientX) - r.left, y: (e.clientY || e.touches[0].clientY) - r.top };
        };

        canvas.onmousedown = canvas.ontouchstart = (e) => {
            if(isLocked || document.getElementById('img-pre-' + id).style.display === 'block') return;
            drawing = true;
            ctx.beginPath();
            const p = getPos(e);
            ctx.moveTo(p.x, p.y);
        };

        canvas.onmousemove = canvas.ontouchmove = (e) => {
            if(!drawing || isLocked) return;
            if(e.touches) e.preventDefault();
            const p = getPos(e);
            ctx.lineTo(p.x, p.y);
            ctx.stroke();
        };

        canvas.onmouseup = canvas.ontouchend = () => { if(drawing) { drawing = false; autoSave(); } };
    }

    function clearSig(id) {
        if(isLocked) return;
        const canvas = document.getElementById('can-' + id);
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('img-pre-' + id).style.display = 'none';
        autoSave();
    }

    function uploadSig(input, id) {
        if(isLocked) return;
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('img-pre-' + id);
                img.src = e.target.result;
                img.style.display = 'block';
                autoSave();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function loadLogo(input) {
        if(isLocked) return;
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('logo-img').src = e.target.result;
                showToast("Logo diperbarui");
                autoSave();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function autoSave() {
        const data = { isLocked: isLocked };
        document.querySelectorAll('.save').forEach(el => data[el.id] = el.value);
        [1,2,3,4].forEach(id => {
            const canvas = document.getElementById('can-' + id);
            const img = document.getElementById('img-pre-' + id);
            data['sig-c-' + id] = canvas.toDataURL();
            data['sig-i-' + id] = img.style.display === 'block' ? img.src : '';
        });
        data['logo_data'] = document.getElementById('logo-img').src;
        localStorage.setItem('psi_v5_config', JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem('psi_v5_config');
        if(!saved) return;
        const data = JSON.parse(saved);
        isLocked = data.isLocked || false;

        if(data['logo_data']) document.getElementById('logo-img').src = data['logo_data'];

        for(let k in data) {
            const el = document.getElementById(k);
            if(el) {
                el.value = data[k];
                if(k.startsWith('sc-')) updateBar(k.split('-')[1]);
                if(k.startsWith('role-')) toggleSig(k.split('-')[1]);
            }
            if(k.startsWith('sig-c-')) {
                const id = k.split('-')[2];
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('can-' + id);
                    if(canvas) canvas.getContext('2d').drawImage(img, 0, 0);
                };
                img.src = data[k];
            }
            if(k.startsWith('sig-i-') && data[k]) {
                const id = k.split('-')[2];
                const img = document.getElementById('img-pre-' + id);
                if(img) {
                    img.src = data[k];
                    img.style.display = 'block';
                }
            }
        }
    }

    function handleExcel(input) {
        if(isLocked) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const row = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])[0];
                if(row) {
                    if(row.Nama) document.getElementById('cfg-nama').value = row.Nama;
                    if(row.ID || row.NISN) document.getElementById('cfg-id').value = row.ID || row.NISN;
                    if(row.Kelas) document.getElementById('cfg-kelas').value = row.Kelas;
                    syncData();
                    showToast("Data Excel berhasil diimpor");
                }
            } catch(err) { showToast("Gagal membaca Excel", "error"); }
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function resetForm() {
        if(isLocked) return;
        if(confirm("Hapus semua data?")) {
            localStorage.removeItem('psi_v5_config');
            location.reload();
        }
    }

    function exportJSON() {
        const data = localStorage.getItem('psi_v5_config');
        const blob = new Blob([data], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Backup_Laporan_Terkunci.json`;
        a.click();
    }

    window.onload = init;
</script>

</body>
</html>
